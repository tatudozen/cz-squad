# Story 4.3: End-to-End Pipeline Orchestration

**Epic:** 4 - Sales Page, Pipeline Integration & Self-Dogfooding
**Story ID:** 4.3
**Status:** InProgress
**Priority:** P0
**Story Points:** 8

## Story Statement

**As a** operator (OPB),
**I want** a unified pipeline that orchestrates all 3 systems from a single briefing,
**so that** I can trigger complete generation with one command and track progress.

## Acceptance Criteria

1. Workflow n8n master: briefing → parallel: Content Pipeline + FunWheel Pipeline + Sales Page Pipeline
2. Sub-pipelines report status: `pending` → `generating` → `ready_for_review` → `approved`
3. Table `projects` in Supabase: `client_id`, `briefing_id`, `status`, IDs for all 3 systems
4. Endpoint `POST /projects/generate` and `GET /projects/:id/status`
5. WhatsApp notification (Evolution) on completion: "Projeto {cliente} pronto para revisão"
6. Error handling: independent systems; isolated failure allows individual retry
7. Total time < 30 minutes for complete package
8. n8n workflow exported as JSON with documentation
9. End-to-end test with CopyZen briefing

## Scope

### In Scope
- Project orchestration service (master pipeline coordinator)
- Projects database table + repository
- Pipeline execution with parallel sub-pipeline dispatch
- Status tracking per sub-pipeline (content, funwheel, sales-page)
- WhatsApp notification on project completion (reuse Evolution API)
- Individual sub-pipeline retry on failure
- REST API endpoints (generate + status)
- n8n workflow JSON definition
- Comprehensive testing

### Out of Scope
- UI for project management (future)
- Advanced analytics dashboard
- A/B testing or variant management
- Real-time progress WebSockets (future)
- Billing or payment integration

## Dependencies

**Prerequisite Stories:**
- Story 1.1 (Project Scaffold) - ✅ DONE
- Story 1.2 (Supabase Schema) - ✅ DONE
- Story 1.3 (Briefing API) - ✅ DONE
- Story 1.4 (Brand Profile) - ✅ DONE
- Story 2.1-2.5 (Content Pipeline) - ✅ DONE
- Story 3.1-3.2 (FunWheel Pipeline) - ✅ DONE
- Story 4.1 (Sales Page Copy) - ✅ DONE
- Story 4.2 (Sales Page Build) - ✅ DONE

**Technical Dependencies:**
- All generator services (content, funwheel, sales-page)
- Evolution API client (from Story 3.2)
- Webhook service with retry (from Story 3.2)
- n8n API configuration (already in config.ts)
- Project type (already in shared/types)

## Dev Notes

### Architecture Context

**Pipeline Flow:**
```
POST /projects/generate
  ├─ 1. Validate briefing + brand profile
  ├─ 2. Create project record (status: 'pending')
  ├─ 3. Start pipeline (status: 'generating')
  │   ├─ Sub-pipeline A: Content Package
  │   ├─ Sub-pipeline B: FunWheel Pages
  │   └─ Sub-pipeline C: Sales Page (copy + build)
  ├─ 4. Track individual statuses
  ├─ 5. All complete → status: 'ready_for_review'
  └─ 6. Send WhatsApp notification
```

**Sub-pipeline Independence:**
Each sub-pipeline runs independently. If one fails, others continue. Failed pipelines can be retried individually via `POST /projects/:id/retry/:pipeline`.

### Data Structure

**Projects Table:**
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL REFERENCES clients(id),
  briefing_id UUID NOT NULL REFERENCES briefings(id),
  brand_profile_id UUID NOT NULL REFERENCES brand_profiles(id),
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  -- Sub-pipeline references
  content_package_id UUID,
  funwheel_id UUID,
  sales_page_id UUID,
  -- Sub-pipeline statuses
  content_status VARCHAR(50) DEFAULT 'pending',
  funwheel_status VARCHAR(50) DEFAULT 'pending',
  sales_page_status VARCHAR(50) DEFAULT 'pending',
  -- Metrics
  tokens_used JSONB DEFAULT '{}',
  estimated_cost DECIMAL(10,2),
  total_time_ms INTEGER,
  -- Timestamps
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  -- Error tracking
  error_log JSONB DEFAULT '[]'
);
```

### File Structure
```
apps/api/src/
├── services/pipeline/
│   ├── orchestrator.ts          (NEW - main pipeline coordinator)
│   ├── __tests__/
│   │   └── orchestrator.test.ts (NEW - 25+ test cases)
├── routes/
│   └── projects.ts              (NEW - REST endpoints)
├── repositories/
│   └── ProjectRepository.ts     (NEW - CRUD for projects table)
docs/n8n-workflows/
│   └── master-pipeline.json     (NEW - n8n workflow definition)
migrations/
│   └── 004_create_projects_table.sql (NEW)
```

### API Specification

```typescript
POST /projects/generate
Payload: {
  briefing_id: UUID
  brand_profile_id: UUID
  client_id: UUID
  operator_phone?: string        // For WhatsApp notification
  pipelines?: {                  // Optional: select specific pipelines
    content: boolean             // default: true
    funwheel: boolean            // default: true
    sales_page: boolean          // default: true
  }
}

Response: {
  id: UUID                       // Project ID
  status: 'pending' | 'generating'
  pipelines: {
    content: { status: string, id?: string }
    funwheel: { status: string, id?: string }
    sales_page: { status: string, id?: string }
  }
  created_at: ISO8601
}

GET /projects/:id/status
Response: {
  id: UUID
  status: string
  pipelines: {
    content: { status: string, id?: string, error?: string }
    funwheel: { status: string, id?: string, error?: string }
    sales_page: { status: string, id?: string, error?: string }
  }
  metrics: {
    total_time_ms?: number
    tokens_used?: object
    estimated_cost?: number
  }
  created_at: ISO8601
  completed_at?: ISO8601
}

POST /projects/:id/retry/:pipeline
Payload: { force?: boolean }
Response: { status: string, pipeline: string, retrying: boolean }
```

---

## Tasks / Subtasks

- [x] Task 1: Create database migration for projects table
  - [x] Create 003_create_projects_table.sql
  - [x] Define columns for sub-pipeline tracking
  - [x] Add RLS policies and indexes

- [x] Task 2: Create ProjectRepository
  - [x] CRUD operations (create, getById, update, list)
  - [x] Update sub-pipeline status method
  - [x] Query by client_id and status
  - [x] Error log and metrics tracking

- [x] Task 3: Create pipeline orchestration service
  - [x] Implement orchestrateProject() main function
  - [x] Implement executeContentPipeline()
  - [x] Implement executeFunWheelPipeline()
  - [x] Implement executeSalesPagePipeline()
  - [x] Pipeline status tracking and aggregation
  - [x] Error handling with per-pipeline isolation
  - [x] WhatsApp notification on completion
  - [x] Token estimation and cost calculation

- [x] Task 4: Create REST API endpoints
  - [x] POST /projects/generate endpoint
  - [x] GET /projects/:id/status endpoint
  - [x] POST /projects/:id/retry/:pipeline endpoint
  - [x] Zod validation schemas
  - [x] Register routes in index.ts

- [x] Task 5: Create n8n workflow definition
  - [x] Master pipeline workflow JSON
  - [x] Webhook trigger configuration
  - [x] Sub-pipeline parallel execution
  - [x] Status callback handlers
  - [x] WhatsApp notification via Evolution API

- [x] Task 6: Testing
  - [x] Test pipeline orchestration (happy path)
  - [x] Test individual pipeline executors
  - [x] Test retry mechanism
  - [x] Test status tracking (buildProjectStatus)
  - [x] Test WhatsApp notification
  - [x] Test edge cases (disabled pipelines, timing)
  - [x] 30 test cases - all passing

---

## Testing

**Test Framework:** Vitest
**Location:** `apps/api/src/services/pipeline/__tests__/`
**Coverage Target:** 80%+

---

---

## Dev Agent Record

### Completion Notes
- [x] Task 1: Migration created (003_create_projects_table.sql)
- [x] Task 2: ProjectRepository completed with full CRUD + pipeline status
- [x] Task 3: Orchestrator service with parallel pipeline execution
- [x] Task 4: REST API endpoints (generate, status, retry)
- [x] Task 5: n8n workflow JSON exported with documentation
- [x] Task 6: 30 test cases - all passing

### File List (Implementation Complete)

**New Files Created:**
- `migrations/003_create_projects_table.sql` (55 lines)
- `apps/api/src/repositories/ProjectRepository.ts` (175 lines)
- `apps/api/src/services/pipeline/orchestrator.ts` (310 lines)
- `apps/api/src/routes/projects.ts` (195 lines)
- `apps/api/src/services/pipeline/__tests__/orchestrator.test.ts` (460 lines)
- `docs/n8n-workflows/master-pipeline.json` (n8n workflow definition)

**Modified Files:**
- `apps/api/src/index.ts` (added /projects route registration)

**Total Lines Added:** ~1,200 lines
**Test Coverage:** 30 test cases (all passing)
**Quality Gates:** TypeScript ✅, Lint ✅, Build ✅, Tests ✅ (30/30)

---

## Change Log

| Date | Version | Description |
|------|---------|-------------|
| 2026-02-26 | 1.0 | Story created in InProgress status |
| 2026-02-26 | 2.0 | YOLO Implementation: Complete pipeline orchestrator (1,200 lines, 30 tests) |
