# Story 1.4: Branding Engine — Brand Profile Generation API

**Epic:** 1 - Foundation & Core Module
**Story ID:** 1.4
**Status:** Ready
**Priority:** P0 (Blocking)
**Story Points:** 13

## Story Statement

**Como** operador (OPB),
**quero** um endpoint que aprova um briefing e gera automaticamente um perfil de marca (cores, tom de voz, diretrizes) usando IA,
**para que** o briefing aprovado alimente imediatamente os sistemas de geração de conteúdo downstream.

## Acceptance Criteria

1. ✅ POST /briefings/{id}/approve endpoint implementado com aprovação por operador
2. ✅ Integração com Claude API para gerar perfil de marca baseado no briefing
3. ✅ POST /brand-profiles com CRUD completo (Create, Read, Update, Delete)
4. ✅ Geração de profile contendo: color_palette (primary, secondary, accent, neutral), voice_guidelines (tone, keywords_to_use, keywords_to_avoid, example_phrases)
5. ✅ Perfil de marca salvo no Supabase com relação ao briefing aprovado
6. ✅ Validação: briefing deve estar em status "approved" antes de gerar perfil
7. ✅ Tratamento de erros: falha na geração retorna 500 com detalhes do erro Claude
8. ✅ Testes e2e para aprovação, geração de perfil e CRUD de brand_profiles
9. ✅ Logging de operações de IA (tokens usados, tempo de processamento, custo estimado)

## Scope

### In Scope
- Briefing approval endpoint (POST /briefings/{id}/approve)
- Claude API integration for brand profile generation
- Brand profile CRUD endpoints
- Zod validation for brand profiles
- Brand profile repository methods
- LLM adapter usage (Claude primary + fallback support)
- Error handling for LLM failures
- Comprehensive E2E tests (10+ scenarios)
- Operation logging with LLM metrics
- Prompt engineering for brand profile generation

### Out of Scope
- UI for approving briefings or generating profiles
- Batch generation of multiple profiles
- Profile templates or presets
- Profile versioning or history
- A/B testing different generation prompts
- Integration with external design tools

## Dependencies

**Prerequisite Stories:**
- Story 1.1 (Project Scaffold) - ✅ DONE
- Story 1.2 (Supabase Schema & Repositories) - ✅ DONE
- Story 1.3 (Briefing Module REST API) - ✅ DONE

**External Dependencies:**
- Supabase Cloud (from Story 1.2)
- Claude API (Anthropic)
- Express.js (from scaffold)
- LLM Adapter (from shared/src/llm)

## Technical Specification

### Claude API Integration

```typescript
// Prompt for brand profile generation
const generateBrandProfilePrompt = (briefing: Briefing): string => `
Given the following client briefing, generate a comprehensive brand profile with specific, actionable guidance.

BRIEFING:
- Business Name: ${briefing.business_name}
- Segment: ${briefing.segment}
- Target Audience: ${briefing.target_audience}
- Voice Tone: ${briefing.voice_tone}
- Objectives: ${briefing.objectives.join(', ')}
- Differentiators: ${briefing.differentiators}
- Existing Colors: ${briefing.existing_colors?.join(', ') || 'None'}

Generate and return ONLY a valid JSON object (no markdown, no code blocks) with this exact structure:
{
  "color_palette": {
    "primary": "#HEX",
    "secondary": "#HEX",
    "accent": "#HEX",
    "neutral": "#HEX"
  },
  "voice_guidelines": {
    "tone": "description of tone",
    "keywords_to_use": ["keyword1", "keyword2"],
    "keywords_to_avoid": ["keyword1", "keyword2"],
    "example_phrases": ["example1", "example2"]
  },
  "visual_style": "description"
}

Ensure:
1. Colors reflect the business segment and target audience
2. Voice tone matches the briefing requirements
3. Keywords are specific to the business domain
4. Example phrases demonstrate the voice in action
`;
```

### API Endpoints

#### POST /briefings/{id}/approve
Approve a briefing and optionally generate brand profile.

```
Request:
{
  "approved_by": "string"
}

Response (200):
{
  "briefing": {
    "id": "uuid",
    "status": "approved",
    "approved_by": "string",
    "approved_at": "ISO8601"
  },
  "brand_profile": {
    "id": "uuid",
    "color_palette": {...},
    "voice_guidelines": {...},
    "created_at": "ISO8601"
  },
  "generation_metrics": {
    "tokens_used": 450,
    "time_ms": 1250,
    "cost_usd": 0.0067
  }
}

Response (404):
{
  "error_code": "NOT_FOUND",
  "message": "Briefing not found"
}

Response (400):
{
  "error_code": "INVALID_STATUS",
  "message": "Briefing must be in draft status to approve"
}

Response (500):
{
  "error_code": "GENERATION_FAILED",
  "message": "Failed to generate brand profile",
  "details": {
    "claude_error": "error message from Claude API"
  }
}
```

#### POST /brand-profiles
Create a brand profile (manual or after approval).

```
Request:
{
  "client_id": "uuid",
  "briefing_id": "uuid",
  "color_palette": {...},
  "voice_guidelines": {...},
  "visual_style": "string"
}

Response (201):
{ "id": "uuid", ... }
```

#### GET /brand-profiles/{id}
Retrieve a brand profile.

```
Response (200):
{
  "id": "uuid",
  "client_id": "uuid",
  "color_palette": {...},
  ...
}
```

#### GET /brand-profiles?client_id=:clientId
List brand profiles for a client.

```
Response (200):
{
  "data": [{ ...profile... }],
  "count": 1
}
```

#### PATCH /brand-profiles/{id}
Update a brand profile.

```
Response (200):
{ "id": "uuid", "updated_at": "ISO8601", ... }
```

#### DELETE /brand-profiles/{id}
Delete a brand profile.

```
Response (204):
(no content)
```

### Error Handling

```typescript
export class GenerationError extends ApiError {
  constructor(message: string, claudeError?: unknown) {
    super(500, 'GENERATION_FAILED', message, {
      claude_error: claudeError instanceof Error ? claudeError.message : String(claudeError),
    });
  }
}
```

### Logging Format

```
[BRIEFING_APPROVED] id={id} approved_by={user} timestamp={ts}
[BRAND_PROFILE_GENERATED] id={id} client_id={cid} tokens={tokens} time_ms={ms} cost_usd={cost}
[GENERATION_FAILED] briefing_id={id} error={error} timestamp={ts}
```

## Tasks / Subtasks

### Task 1: Briefing Approval Endpoint
- [ ] Implement POST /briefings/:id/approve
- [ ] Update briefing status to "approved"
- [ ] Set approved_at timestamp and approved_by user
- [ ] Trigger brand profile generation
- [ ] Return approval + generation result together

### Task 2: LLM Integration
- [ ] Create brand profile generation prompt
- [ ] Integrate with LLM adapter (Claude primary)
- [ ] Implement error handling for LLM failures
- [ ] Parse and validate Claude JSON response
- [ ] Calculate token usage and cost

### Task 3: Brand Profile Generation
- [ ] Create BrandProfileRepository methods (create, getById, update, delete, getByClientId)
- [ ] Implement generation logic in approval endpoint
- [ ] Validate generated color values (hex format)
- [ ] Validate keywords arrays (non-empty)
- [ ] Handle generation timeout (>30s) with user-friendly error

### Task 4: Brand Profile Routes
- [ ] Create `apps/api/src/routes/brand-profiles.ts`
- [ ] Implement all 5 CRUD endpoints
- [ ] Validation using Zod schemas
- [ ] Error handling (400, 404, 500)
- [ ] Logging for all operations

### Task 5: Validation Schemas
- [ ] Create `packages/shared/src/schemas/brand-profile-request.ts`
- [ ] Define CreateBrandProfileRequest schema
- [ ] Define UpdateBrandProfileRequest schema
- [ ] Add color hex validation
- [ ] Add voice_guidelines structure validation

### Task 6: E2E Tests
- [ ] Create `apps/api/src/__tests__/brand-profiles.e2e.test.ts`
- [ ] Test approve briefing with successful generation (200)
- [ ] Test approve non-existent briefing (404)
- [ ] Test approve already approved briefing (400)
- [ ] Test LLM generation failure scenario (500)
- [ ] Test brand profile CRUD operations (POST, GET, PATCH, DELETE)
- [ ] Test error responses with valid error codes
- [ ] Test color palette validation
- [ ] Test voice_guidelines validation
- [ ] Mock Claude API for deterministic tests

### Task 7: Observability & Metrics
- [ ] Add generation metrics logging (tokens, time, cost)
- [ ] Log Claude API response time
- [ ] Track generation success/failure rate
- [ ] Document cost estimation formula
- [ ] Add debug logging for troubleshooting

## Dev Agent Record

**Assigned To:** @dev
**Current Status:** Ready for Development
**Last Updated:** 2026-02-24 23:50 (Story Created)

### Execution Plan
1. ⏳ Understand requirements (AC + Technical Spec)
2. ⏳ Implement approval endpoint with generation (Task 1-2)
3. ⏳ Build BrandProfileRepository (Task 3)
4. ⏳ Create brand profile routes (Task 4)
5. ⏳ Write validation schemas (Task 5)
6. ⏳ Implement comprehensive tests (Task 6)
7. ⏳ Add observability/metrics (Task 7)
8. ⏳ Run quality gates (lint, typecheck, tests)
9. ⏳ Mark complete

### Debug Log
- Created: 2026-02-24 23:50 by autonomous @dev (YOLO mode)
- Status: Ready for development

## File List

**New Files:**
- `apps/api/src/routes/brand-profiles.ts` — Brand profile CRUD endpoints
- `apps/api/src/__tests__/brand-profiles.e2e.test.ts` — E2E tests for brand profiles
- `packages/shared/src/schemas/brand-profile-request.ts` — Brand profile validation schemas
- `packages/shared/src/services/brand-profile-service.ts` — Brand profile generation service

**Modified Files:**
- `apps/api/src/index.ts` — Import brand profile routes
- `apps/api/src/routes/briefings.ts` — Add approval endpoint
- `packages/shared/src/repositories/index.ts` — Add BrandProfileRepository methods

**Deleted Files:**
- None

## Change Log

| Date | Author | Change |
|------|--------|--------|
| 2026-02-24 | @dev (YOLO) | Story created - Ready for development |

---

**Story created autonomously by @dev (YOLO mode)**
**Ready for implementation**
