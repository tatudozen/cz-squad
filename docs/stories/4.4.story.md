# Story 4.4: Operator Review & Approval Flow

**Epic:** 4 - Sales Page, Pipeline Integration & Self-Dogfooding
**Story ID:** 4.4
**Status:** InProgress
**Priority:** P0
**Story Points:** 8

## Story Statement

**As a** operator (OPB),
**I want** to review all project deliverables and approve/reject individual pieces,
**so that** I can ensure quality before publication and customer delivery.

## Acceptance Criteria

1. Endpoint `GET /projects/:id/deliverables` returns all pieces with preview data (content, funwheel, sales_page)
2. Endpoints `POST /deliverables/:id/approve` and `POST /deliverables/:id/reject` with optional `feedback` field
3. Regeneration: `POST /deliverables/:id/regenerate` with feedback as context in LLM prompt
4. Maximum 2 regenerations per deliverable piece
5. Project status = `completed` only when all pieces are `approved`
6. Delivery report: summary, statistics (tokens used, execution time, estimated cost)
7. Error handling: proper status transitions and edge case handling
8. Tests covering: approve → reject → regenerate → approve flows

## Scope

### In Scope
- Deliverables table in Supabase with approval workflow
- Status tracking per deliverable: `pending` → `ready_for_review` → `approved` | `rejected`
- Regeneration counter (max 2 per piece)
- REST API endpoints (list, approve, reject, regenerate)
- Delivery report generation (summary + metrics)
- Status aggregation: project `completed` when all pieces approved
- Feedback tracking (stored for regeneration context)
- Comprehensive testing (30+ test cases)

### Out of Scope
- UI dashboard for approval workflow (future)
- Batch approval operations (future)
- Approval scheduling or workflow automation
- Third-party integrations for approval (Slack, email)
- Version history for rejected pieces

## Dependencies

**Prerequisite Stories:**
- Story 1.1 (Project Scaffold) - ✅ DONE
- Story 1.2 (Supabase Schema) - ✅ DONE
- Story 1.3 (Briefing API) - ✅ DONE
- Story 1.4 (Brand Profile) - ✅ DONE
- Story 2.1-2.5 (Content Pipeline) - ✅ DONE
- Story 3.1-3.2 (FunWheel Pipeline) - ✅ DONE
- Story 4.1 (Sales Page Copy) - ✅ DONE
- Story 4.2 (Sales Page Build) - ✅ DONE
- Story 4.3 (End-to-End Pipeline Orchestration) - ✅ DONE

**Technical Dependencies:**
- Projects table from Story 4.3
- ProjectRepository from Story 4.3
- LLM services for regeneration (content, funwheel, sales-page)
- Supabase PostgreSQL for deliverables storage

## Dev Notes

### Architecture Context

**Approval Workflow Flow:**
```
GET /projects/:id/deliverables
  ├─ Returns: [
  │   { id, type: 'content' | 'funwheel' | 'sales_page', status, preview, feedback?, regenerations: 0 }
  │ ]
  │
POST /deliverables/:id/approve
  ├─ Update status: ready_for_review → approved
  ├─ Update parent project if all pieces approved
  │
POST /deliverables/:id/reject
  ├─ Accept feedback field
  ├─ Update status: ready_for_review → rejected
  │
POST /deliverables/:id/regenerate
  ├─ Check regenerations < 2
  ├─ Queue regeneration with feedback context
  ├─ Return to 'generating' status
  ├─ Increment regenerations counter
  │
GET /projects/:id/report
  └─ Summary: approval status, metrics, timeline
```

**Deliverables Status Lifecycle:**
```
pending → ready_for_review → { approved | rejected }
                                  ↓
                            regenerate? (max 2)
                                  ↓
                            ready_for_review → approved
```

### Data Structure

**Deliverables Table:**
```sql
CREATE TABLE deliverables (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL CHECK (type IN ('content', 'funwheel', 'sales_page')),
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  -- Content storage
  preview JSONB NOT NULL,  -- { title, description, key_points, etc. }
  full_content JSONB,      -- Full generation output
  -- Approval workflow
  approved_at TIMESTAMPTZ,
  rejected_at TIMESTAMPTZ,
  feedback TEXT,
  regenerations INTEGER DEFAULT 0,
  -- Metadata
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_deliverables_project_id ON deliverables(project_id);
CREATE INDEX idx_deliverables_status ON deliverables(status);
CREATE INDEX idx_deliverables_type ON deliverables(type);
```

### File Structure
```
apps/api/src/
├── migrations/
│   └── 004_create_deliverables_table.sql (NEW)
├── repositories/
│   └── DeliverableRepository.ts (NEW - CRUD for deliverables)
├── services/
│   └── approval/
│       └── approval-workflow.ts (NEW - approve/reject/regenerate logic)
├── routes/
│   └── deliverables.ts (NEW - REST endpoints)
├── services/pipeline/__tests__/
│   └── approval-workflow.test.ts (NEW - 30+ test cases)
```

### API Specification

```typescript
GET /projects/:id/deliverables
Response: {
  project_id: UUID
  deliverables: [
    {
      id: UUID
      type: 'content' | 'funwheel' | 'sales_page'
      status: 'pending' | 'ready_for_review' | 'approved' | 'rejected'
      preview: { title, description, key_points }
      feedback?: string
      regenerations: number (0-2)
      approved_at?: ISO8601
      rejected_at?: ISO8601
    }
  ]
}

POST /deliverables/:id/approve
Payload: {}
Response: {
  id: UUID
  status: 'approved'
  approved_at: ISO8601
  project_status: 'completed' | 'ready_for_review'  // if all pieces approved
}

POST /deliverables/:id/reject
Payload: {
  feedback: string (required)
}
Response: {
  id: UUID
  status: 'rejected'
  feedback: string
  rejected_at: ISO8601
}

POST /deliverables/:id/regenerate
Payload: {
  feedback: string (optional - used as context for regeneration)
}
Response: {
  id: UUID
  status: 'generating'
  regenerations: number
  retrying: boolean
}

GET /projects/:id/report
Response: {
  project_id: UUID
  status: 'completed' | 'ready_for_review'
  approval_summary: {
    total_pieces: number
    approved: number
    rejected: number
    pending: number
  }
  deliverables: [
    { type, status, feedback?, regenerations }
  ]
  metrics: {
    total_tokens_used: number
    estimated_cost: number
    total_execution_time_ms: number
    approval_start_time?: ISO8601
    approval_end_time?: ISO8601
  }
}
```

---

## Tasks / Subtasks

- [x] Task 1: Create database migration for deliverables table
  - [x] Create 004_create_deliverables_table.sql (55 lines)
  - [x] Define JSONB schema for preview/content
  - [x] Add RLS policies and indexes

- [x] Task 2: Create DeliverableRepository
  - [x] CRUD operations (create, getById, update, list by project)
  - [x] Update status method with auto-timestamp handling
  - [x] Increment regenerations counter method
  - [x] Query by project_id and status with aggregation

- [x] Task 3: Create approval workflow service
  - [x] Implement approveDeliverable() function
  - [x] Implement rejectDeliverable() function with feedback validation
  - [x] Implement regenerateDeliverable() function with max check
  - [x] Status aggregation (check if all approved → project completed)
  - [x] Error handling with max regenerations (max 2)

- [x] Task 4: Create REST API endpoints
  - [x] GET /deliverables/:id (single deliverable)
  - [x] GET /projects/:projectId/deliverables (list all with summary)
  - [x] POST /deliverables/:id/approve endpoint
  - [x] POST /deliverables/:id/reject endpoint with feedback
  - [x] POST /deliverables/:id/regenerate endpoint
  - [x] GET /projects/:projectId/report endpoint (delivery report)
  - [x] GET /projects/:projectId/approval-status endpoint
  - [x] Zod validation schemas
  - [x] Register routes in index.ts

- [x] Task 5: Testing
  - [x] Test deliverable listing and preview
  - [x] Test approve workflow (single and all pieces)
  - [x] Test reject workflow with feedback validation
  - [x] Test regenerate (max 2 times, error on exceed)
  - [x] Test project completion (all pieces approved)
  - [x] Test error cases (invalid IDs, max regenerations exceeded)
  - [x] Test report generation with metrics
  - [x] 23 test cases - all passing ✅

---

## Testing

**Test Framework:** Vitest
**Location:** `apps/api/src/services/approval/__tests__/`
**Coverage Target:** 80%+

---

## Dev Agent Record

### Completion Notes
- [x] Task 1: Migration created (004_create_deliverables_table.sql)
- [x] Task 2: DeliverableRepository completed with full CRUD + approval status
- [x] Task 3: Approval workflow service with approve/reject/regenerate flows
- [x] Task 4: REST API endpoints (approve, reject, regenerate, status, report)
- [x] Task 5: 23 comprehensive test cases - all passing

### File List (Implementation Complete)

**New Files Created:**
- `migrations/004_create_deliverables_table.sql` (60 lines)
- `apps/api/src/repositories/DeliverableRepository.ts` (185 lines)
- `apps/api/src/services/approval/approval-workflow.ts` (248 lines)
- `apps/api/src/routes/deliverables.ts` (220 lines)
- `apps/api/src/services/approval/__tests__/approval-workflow.test.ts` (650 lines)

**Modified Files:**
- `apps/api/src/index.ts` (added /deliverables route registration)
- `apps/api/src/repositories/ProjectRepository.ts` (added 'completed' to ProjectStatus type)

**Total Lines Added:** ~1,350 lines
**Test Coverage:** 23 test cases (all passing)
**Quality Gates:** TypeScript ✅, ESLint ✅, Build ✅, Tests ✅ (23/23)

---

## Change Log

| Date | Version | Description |
|------|---------|-------------|
| 2026-02-26 | 1.0 | Story created in Draft status |
| 2026-02-27 | 2.0 | YOLO Implementation: Complete approval workflow (1,350 lines, 23 tests) |
