---
/**
 * Carousel Component
 * Renders Instagram carousel slides with copy and design briefs
 *
 * Story 2.5: Carousel Astro Component (Epic 2)
 */

import type { Carousel } from '@api/services/content/generators/carousel';
import type { DesignBriefCarousel } from '@api/services/content/generators/design-brief';
import CarouselSlide from './CarouselSlide.astro';
import CarouselNav from './CarouselNav.astro';

interface Props {
  carousel: Carousel;
  designBrief?: DesignBriefCarousel;
  autoPlay?: boolean;
  autoPlayDuration?: number;
}

const {
  carousel,
  designBrief,
  autoPlay = true,
  autoPlayDuration = 5000,
} = Astro.props;

// Extract color palette from design brief
const primaryColor = designBrief?.color_palette?.[0]?.hex || '#06164A';
const secondaryColor = designBrief?.color_palette?.[1]?.hex || '#6220FF';
const heading = designBrief?.typography?.heading || 'Poppins Bold';
const body = designBrief?.typography?.body || 'Inter Regular';
---

<style define:vars={{
  primaryColor,
  secondaryColor,
  headingFont: heading,
  bodyFont: body,
}}>
  .carousel-container {
    width: 100%;
    max-width: 1080px;
    margin: 0 auto;
    aspect-ratio: 1 / 1.25;
    position: relative;
    background: #f5f5f5;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .carousel-viewport {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .carousel-slides {
    display: flex;
    width: 100%;
    height: 100%;
    transition: transform 0.5s ease-in-out;
  }

  .carousel-slide {
    flex: 0 0 100%;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 2rem;
    text-align: center;
    background: white;
  }

  .slide-content {
    max-width: 90%;
    z-index: 2;
  }

  .slide-title {
    font-family: var(--headingFont), sans-serif;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    font-weight: 700;
    color: var(--primaryColor);
    margin: 0 0 1rem 0;
    line-height: 1.3;
  }

  .slide-subtitle {
    font-family: var(--bodyFont), sans-serif;
    font-size: clamp(1rem, 2vw, 1.25rem);
    color: #666;
    margin: 0;
    line-height: 1.5;
  }

  .slide-indicator {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    z-index: 3;
  }

  .indicator-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .indicator-dot.active {
    background: var(--primaryColor);
  }

  @media (max-width: 640px) {
    .carousel-container {
      aspect-ratio: 9 / 16;
    }

    .carousel-slide {
      padding: 1.5rem;
    }

    .slide-title {
      font-size: 1.25rem;
    }

    .slide-subtitle {
      font-size: 0.875rem;
    }
  }

  /* Responsive grid for multiple carousels */
  @media (min-width: 1200px) {
    .carousel-container {
      aspect-ratio: auto;
      height: 600px;
    }
  }
</style>

<div
  class="carousel-container"
  data-carousel-id={carousel.id}
  data-auto-play={autoPlay}
  data-auto-play-duration={autoPlayDuration}
  role="region"
  aria-label="Product carousel"
>
  <div class="carousel-viewport">
    <div class="carousel-slides" id={`slides-${carousel.id}`}>
      {carousel.slides.map((slide) => (
        <CarouselSlide
          slide={slide}
          carouselId={carousel.id}
          ariaLabel={`Slide ${slide.slide_number} of ${carousel.slides.length}`}
        />
      ))}
    </div>

    <CarouselNav
      carouselId={carousel.id}
      slideCount={carousel.slides.length}
      autoPlay={autoPlay}
    />

    <div class="slide-indicator" role="tablist" aria-label="Slide indicators">
      {carousel.slides.map((slide, index) => (
        <button
          key={`indicator-${index}`}
          class={`indicator-dot ${index === 0 ? 'active' : ''}`}
          role="tab"
          aria-label={`Go to slide ${index + 1}`}
          aria-selected={index === 0}
          data-slide-index={index}
          onclick={`window.carouselManager?.goToSlide('${carousel.id}', ${index})`}
        />
      ))}
    </div>
  </div>
</div>

<script define:vars={{ carouselId: carousel.id, slideCount: carousel.slides.length, autoPlay, autoPlayDuration }}>
  // Client-side carousel manager
  if (!window.carouselManager) {
    window.carouselManager = {
      carousels: {},
      goToSlide(id, index) {
        const carousel = this.carousels[id];
        if (carousel) {
          carousel.currentSlide = index;
          carousel.updateDisplay();
          if (carousel.autoPlayInterval) clearInterval(carousel.autoPlayInterval);
          if (carousel.autoPlay) carousel.startAutoPlay();
        }
      },
      nextSlide(id) {
        const carousel = this.carousels[id];
        if (carousel) {
          carousel.currentSlide = (carousel.currentSlide + 1) % carousel.slideCount;
          carousel.updateDisplay();
          if (carousel.autoPlayInterval) clearInterval(carousel.autoPlayInterval);
          if (carousel.autoPlay) carousel.startAutoPlay();
        }
      },
      prevSlide(id) {
        const carousel = this.carousels[id];
        if (carousel) {
          carousel.currentSlide = (carousel.currentSlide - 1 + carousel.slideCount) % carousel.slideCount;
          carousel.updateDisplay();
          if (carousel.autoPlayInterval) clearInterval(carousel.autoPlayInterval);
          if (carousel.autoPlay) carousel.startAutoPlay();
        }
      },
    };
  }

  // Initialize carousel
  const container = document.querySelector(`[data-carousel-id="${carouselId}"]`);
  if (container) {
    const carousel = {
      id: carouselId,
      slideCount: slideCount,
      currentSlide: 0,
      autoPlay: autoPlay,
      autoPlayDuration: autoPlayDuration,
      autoPlayInterval: null,
      updateDisplay() {
        const slidesContainer = document.getElementById(`slides-${this.id}`);
        const indicators = document.querySelectorAll(`[data-carousel-id="${this.id}"] .indicator-dot`);
        if (slidesContainer) {
          slidesContainer.style.transform = `translateX(-${this.currentSlide * 100}%)`;
        }
        indicators.forEach((dot, i) => {
          dot.classList.toggle('active', i === this.currentSlide);
          dot.setAttribute('aria-selected', i === this.currentSlide ? 'true' : 'false');
        });
      },
      startAutoPlay() {
        this.autoPlayInterval = setInterval(() => {
          window.carouselManager.nextSlide(this.id);
        }, this.autoPlayDuration);
      },
      pauseAutoPlay() {
        if (this.autoPlayInterval) clearInterval(this.autoPlayInterval);
      },
    };

    window.carouselManager.carousels[carouselId] = carousel;

    // Pause auto-play on hover
    container.addEventListener('mouseenter', () => carousel.pauseAutoPlay());
    container.addEventListener('mouseleave', () => {
      if (carousel.autoPlay) carousel.startAutoPlay();
    });

    // Keyboard navigation
    container.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') window.carouselManager.nextSlide(carouselId);
      if (e.key === 'ArrowLeft') window.carouselManager.prevSlide(carouselId);
      if (e.key === ' ') {
        e.preventDefault();
        carousel.autoPlay = !carousel.autoPlay;
        if (carousel.autoPlay) carousel.startAutoPlay();
        else carousel.pauseAutoPlay();
      }
    });

    // Touch swipe support
    let touchStartX = 0;
    container.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    });
    container.addEventListener('touchend', (e) => {
      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) window.carouselManager.nextSlide(carouselId);
        else window.carouselManager.prevSlide(carouselId);
      }
    });

    // Start auto-play if enabled
    if (carousel.autoPlay) carousel.startAutoPlay();
  }
</script>
